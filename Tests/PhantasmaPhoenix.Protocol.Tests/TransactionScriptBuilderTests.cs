using PhantasmaPhoenix.Core;
using PhantasmaPhoenix.Core.Extensions;
using PhantasmaPhoenix.Cryptography;
using PhantasmaPhoenix.Protocol;
using PhantasmaPhoenix.VM;
using Shouldly;
using Xunit;

namespace PhantasmaPhoenix.Protocol.Tests;

public class TransactionScriptBuilderTests
{
	private const string TestWif = "L5UEVHBjujaR1721aZM5Zm5ayjDyamMZS9W35RE9Y9giRkdf3dVx";
	private const string ExpectedScriptHex =
		"0D00030350340303000D000302102703000D000223220000000000000000000000000000000000000000000000000000000000000000000003000D000223220100AA53BE71FC41BC0889B694F4D6D03F7906A3D9A21705943CAF9632EEAFBB489503000D000408416C6C6F7747617303000D0004036761732D00012E010D0003010003000D00041D73797374656D2E6E657875732E70726F746F636F6C2E76657273696F6E03000D00042F50324B464579466576705166536157384734566A536D6857555A585234517247395951523148624D7054554370434C03000D00040A53696E676C65566F746503000D000409636F6E73656E7375732D00012E010D000223220100AA53BE71FC41BC0889B694F4D6D03F7906A3D9A21705943CAF9632EEAFBB489503000D0004085370656E6447617303000D0004036761732D00012E010B";
	private const string ExpectedSignedTxHex =
		"07746573746E6574046D61696EFD42010D00030350340303000D000302102703000D000223220000000000000000000000000000000000000000000000000000000000000000000003000D000223220100AA53BE71FC41BC0889B694F4D6D03F7906A3D9A21705943CAF9632EEAFBB489503000D000408416C6C6F7747617303000D0004036761732D00012E010D0003010003000D00041D73797374656D2E6E657875732E70726F746F636F6C2E76657273696F6E03000D00042F50324B464579466576705166536157384734566A536D6857555A585234517247395951523148624D7054554370434C03000D00040A53696E676C65566F746503000D000409636F6E73656E7375732D00012E010D000223220100AA53BE71FC41BC0889B694F4D6D03F7906A3D9A21705943CAF9632EEAFBB489503000D0004085370656E6447617303000D0004036761732D00012E010BD202964909436F6E73656E737573010140F1C0410D49A5EDF0945B0EE9FAFDF6CA1FC315118D545E07824BEF1BA1F00881C29419648FD0B8200A356D21FAF45C60F4B77279D931CE4D732F5896E93BFE0D";
	private const string KnownTxHex =
		"07746573746E6574046D61696E03010203D2029649077061796C6F61640101404C033859A20A4FC2E469B3741FB05ACEDFEC24BFE92E07633680488665D79F916773FF40D0E81C4468E1C1487E6E1E6EEFDA5C5D7C53C15C4FB349C2349A1802";

	[Fact]
	public void ScriptBuilder_matches_ts_script_vector()
	{
		var script = BuildConsensusSingleVoteScript();
		script.ToHex().ShouldBe(ExpectedScriptHex);
	}

	[Fact]
	public void Transaction_serializes_to_ts_vector()
	{
		var keys = PhantasmaKeys.FromWIF(TestWif);
		var script = BuildConsensusSingleVoteScript();
		var expiration = new Timestamp(1234567890);
		var payload = "Consensus".AsByteArray();

		var tx = new Transaction("testnet", "main", script, expiration, payload);
		tx.Sign(keys);

		tx.ToByteArray(true).ToHex().ShouldBe(ExpectedSignedTxHex);
	}

	[Fact]
	public void Transaction_unserialize_matches_known_fields()
	{
		var tx = Transaction.Unserialize(KnownTxHex.FromHex()!);

		tx.ShouldNotBeNull();
		tx!.NexusName.ShouldBe("testnet");
		tx.ChainName.ShouldBe("main");
		tx.Script.ToHex().ShouldBe("010203");
		tx.Payload.ToHex().ShouldBe("7061796C6F6164");
		tx.Expiration.Value.ShouldBe(1234567890u);
		tx.Signatures.Length.ShouldBe(1);
	}

	private static byte[] BuildConsensusSingleVoteScript()
	{
		var keys = PhantasmaKeys.FromWIF(TestWif);
		var gasLimit = 10000;
		var gasPrice = 210000;
		var subject = "system.nexus.protocol.version";

		var sb = new ScriptBuilder();
		// Keep TS argument order (gasLimit, gasPrice) to match the shared test input.
		return sb
			.AllowGas(keys.Address, Address.Null, gasLimit, gasPrice)
			.CallContract("consensus", "SingleVote", keys.Address.Text, subject, 0)
			.SpendGas(keys.Address)
			.EndScript();
	}
}
